rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // Allow public form submissions with restrictions
    match /user_forms/{websiteId}/forms/{formId}/submissions/{submissionId} {
      // Allow anyone to create new submissions
      allow create: if
        // Must have required fields
        request.resource.data.keys().hasAll(['formName', 'formType', 'formData', 'submittedAt', 'status', 'read']) &&
        // formData must be a map/object
        request.resource.data.formData is map &&
        // Status must be 'new'
        request.resource.data.status == 'new' &&
        // Read flag must be false
        request.resource.data.read == false &&
        // Must have a valid timestamp
        request.resource.data.submittedAt == request.time;

      // Prevent updates and deletes from public
      allow update, delete: if false;

      // Only authenticated admin users can read submissions
      allow read: if request.auth != null && request.auth.token.admin == true;
    }
  }
}
